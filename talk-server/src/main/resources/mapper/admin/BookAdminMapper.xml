<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cc.talkserver.admin.mapper.BookAdminMapper">

    <select id="findHotBooksByMonthAndTag" resultType="com.cc.talkpojo.entity.Book">
        SELECT b.*
        FROM book b
                 JOIN book_tag_relation b_tag ON b.id = b_tag.book_id
                 LEFT JOIN book_rating r ON b.id = r.book_id
        WHERE b_tag.tag_id = #{hotTagId}
          AND DATE_FORMAT(r.create_time, '%Y-%m') = #{month}
        GROUP BY b.id
        ORDER BY COUNT(r.id) DESC, AVG(r.score) DESC
        LIMIT #{limit}
    </select>
</mapper>
